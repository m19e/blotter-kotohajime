<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Blotter</title>
    <script src="blotter.min.js"></script>
    <script src="materials/channelSplitMaterial.js"></script>
    <script src="materials/fliesMaterial.js"></script>
    <script src="materials/slidingDoorMaterial.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
  </head>
  <body>
    <div id="app">
      <button @click="render">描画〜〜〜</button>
      <button @click="loaded">なんでもいい</button>
      <h2 v-if="isLoad">読み込んだよ〜〜〜〜</h2>
      <div id="logo" v-else></div>
    </div>
  </body>
  <script type="text/javascript">
    function someAsyncFn(n) {
      return new Promise(resolve => {
        setTimeout(() => {
          console.log(n);
          resolve(n + 1);
        }, 50);
      });
    }
    function someAsyncCond(n) {
      return new Promise(resolve => {
        resolve(n <= 75);
      });
    }
    const app = new Vue({
      el: "#app",
      data: () => ({
        spread: 0.5,
        isLoad: false
      }),
      mounted() {
        //do something after mounting vue instance
        this.render();
        this.sleep(5000).then(()=>{
          console.log("sleep")
          this.loaded()
        });
        // (async function() {
        //   for (let i = 0; await someAsyncCond(i); i++) {
        //     await someAsyncFn(i);
        //   }
        // })();
      },
      computed: {},
      methods: {
        render() {
          let text = new Blotter.Text("scent", {
            family: "serif",
            size: 120,
            fill: "#171717"
          });

          let material = new Blotter.FliesMaterial();

          // materialにプロパティを渡すよ
          material.uniforms.uPointCellWidth.value = 0.01;
          material.uniforms.uPointRadius.value = 0.85;
          material.uniforms.uDodge.value = 1.0;
          material.uniforms.uDodgePosition.value = [0, 0];
          material.uniforms.uDodgeSpread.value = 0;
          material.uniforms.uSpeed.value = 6;

          let blotter = new Blotter(material, { texts: text });

          let scope = blotter.forText(text);
          scope.appendTo(document.getElementById("logo"));
          // for (let i = 0; i < 10; i++) {
          //   this.sleep(2000).then(() => {
              // material.uniforms.uDodgeSpread.value += 0.1

          (async function() {
            for (let i = 0; await someAsyncCond(i); i++) {
              await someAsyncFn(i)
              material.uniforms.uDodgeSpread.value += 0.05
            }
          })();
        },
        loaded() {
          this.isLoad = true;
        },
        fadeOut() {
          this.spread += 0.2;
        },
        sleep(waitSec) {
          return new Promise(resolve => {
            setTimeout(() => {
              resolve();
            }, waitSec);
          });
        },
      }
    });
  </script>
</html>
